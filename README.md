# IFC-IDS-REPORT — инструмент проверки IDS для IFC-моделей

==Ридми писал ИИ, потом исправлю==

Проект представляет собой небольшое приложение на Flet, которое позволяет загружать IFC-модели и IDS-правила (IDS, XML), запускать валидацию при помощи `ifctester`/`ifcopenshell` и получать интерактивный отчёт в браузере или в настольной версии.

## Цели и планируемый функционал

- **Загрузка моделей и правил**: пользователь может загрузить IFC-файл и связанный IDS-файл через удобный интерфейс.
- **Выбор типа отчёта**: несколько форматов отчёта (сводка IDS, предварительный просмотр raw IDS, сводка сущностей IFC, сводка PSet / свойств и т.д.).
- **Валидация IDS**: использовать `ifctester.ids.from_string(...)` и `Ids.validate(model, ...)` для проверки соответствия IDS спецификации и вывода подробных результатов (passed / failed / applicable entities).
- **Поддержка Web (Pyodide) и Desktop**: приложение запускается как локально (Flet desktop), так и в браузере (Flet web + Pyodide). Для работы в браузере предусмотрена загрузка WASM-колеса `ifcopenshell` через `micropip` и механизм кэширования для ускорения повторных запусков.
- **Фоновая установка и UX**: при первом запуске в веб-режиме необходимые WASM-пакеты устанавливаются в фоне (с индикатором прогресса). UI блокируется модальным оверлеем на время установки, чтобы избежать действий пользователя в неподходящий момент.
- **Кэширование wheel'ов**: для веб-версии предусмотрена опция кэшировать `.whl` в Cache API (или хранить колёса в `dist/wheels/` для публикации на GitHub Pages), чтобы не скачивать большие файлы при каждом запуске.

## Установка и запуск (локально)

1. Создайте и активируйте виртуальное окружение (macOS / zsh):

```bash
python3 -m venv .venv
source .venv/bin/activate
python -m pip install --upgrade pip
python -m pip install -r requirements.txt
```

2. Запуск локально в режиме веб (откроется браузер):

```bash
flet run --web src/main.py
```

3. Запуск локально в настольном режиме (desktop):

```bash
flet src/main.py
```

## Публикация для GitHub Pages

- Используйте `flet publish --distpath ../dist src/main.py` (встроенный воркфлоу генерирует `dist/`).
- Рекомендуется копировать нужные `.whl` (если вы хотите поддержать установку в браузере) в `dist/wheels/` перед публикацией, чтобы обеспечить same-origin доступ и избежать проблем с CORS/opaque responses.

Пример команды (скрипт `scripts/build_web.sh` может содержать эти шаги):

```bash
flet publish --distpath ../dist src/main.py
mkdir -p ../dist/wheels
cp wheels/*.whl ../dist/wheels/
```

## Особенности веб-установки (Pyodide)

- В веб-режиме используется `micropip` для установки WASM-колеса `ifcopenshell` и Python-пакета `ifctester`.
- Для надёжности постановлена логика: сначала попытаться установить из локального кэша (Cache API), затем установить из same-origin URL (`/wheels/…`) или, при отсутствии, из внешнего URL. Это даёт лучшее сочетание производительности и надёжности.
- Проблемы, о которых стоит помнить:
  - raw.githubusercontent.com и некоторые внешние хосты могут выдавать "opaque" ответы или блокировать CORS — из-за этого кэширование и установка из blobs могут не работать. Решение — размещать wheel'ы same-origin.
  - В Pyodide нужно дождаться инициализации `pyodide` и доступности `micropip` прежде чем вызывать `micropip.install`.

## Структура репозитория

- `src/main.py` — основной UI-приложение на Flet (точка входа для publish/веб).
- `src/initialize.py` — логика установки пакетов в вебе/браузере, helper-функции установки и проверки наличия модулей.
- `wheels/` — место для хранения локальных wheel-файлов (опционально для публикации).
- `scripts/build_web.sh` — вспомогательный скрипт для сборки и копирования wheel-файлов в `dist/`.

## Отладка и советы

- Если в браузере `localStorage` не получает флаг установки (например, `ifcopenshell_wasm_installed_v1` отсутствует), проверьте DevTools → Network на наличие запроса к `.whl` и тип ответа (`type` должен быть `cors`/`basic`, не `opaque`).
- В DevTools Console запускайте быстрые проверки:
  - `console.log('pyodide' in window)` — проверить, доступен ли Pyodide;
  - `caches.open('ifcopenshell-wheel-cache-v1').then(console.log).catch(console.error)` — проверить Cache API;
  - `localStorage.getItem('ifcopenshell_wasm_installed_v1')` — проверить флаг установки.
- Если вы видите `fetch` с `type: "opaque"`, переместите wheel в `dist/wheels/` и используйте относительный URL.

## Дальнейшие улучшения (план)

- Поддержка экспорта отчётов в PDF/ODF.
- Расширенные форматы отчётов: подробные деревья по сущностям, фильтрация по типам ошибок, ссылки на элементы IFC.
- Историзация результатов: хранение прошлых отчётов и их сравнение.
- UI/UX: прогресс-бар загрузки для больших wheel-файлов, кнопка повтора установки, кнопка сброса кэша.

## Контакты и вклад

- Открыт к PR и предложениям.
